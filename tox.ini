[tox]
envlist =
    py39,
    py310,
    py311,
    py312,
    lint,
    type,
    format,
    security,
    coverage,
    docs
isolated_build = True
skip_missing_interpreters = True

[testenv]
deps =
    pytest>=7.0.0
    pytest-mock>=3.10.0
    -r{toxinidir}/requirements.txt
    -r{toxinidir}/requirements-test.txt
commands =
    pytest {posargs:tests/unit}

[testenv:lint]
description = Run linters (flake8, black, isort)
skip_install = True
deps =
    flake8>=6.0.0
    flake8-docstrings>=1.7.0
    flake8-import-order>=0.18.0
    flake8-bugbear>=23.0.0
    flake8-comprehensions>=3.14.0
    black>=23.0.0
    isort>=5.12.0
    -r{toxinidir}/requirements-test.txt
commands =
    flake8 maas_cpu_analyzer/ tests/ --max-line-length=88 --extend-ignore=E203,W503,E501,D100,D101,D102,D103,D104,D105,D107,D400,D401,I100,I201
    black --check --diff maas_cpu_analyzer/ tests/
    isort --check-only --diff maas_cpu_analyzer/ tests/

[testenv:type]
description = Run type checker (mypy)
deps =
    mypy>=1.5.0
    -r{toxinidir}/requirements.txt
    -r{toxinidir}/requirements-test.txt
commands =
    mypy maas_cpu_analyzer/ --ignore-missing-imports

[testenv:format]
description = Check code formatting
deps =
    black>=23.0.0
    isort>=5.12.0
    -r{toxinidir}/requirements-test.txt
commands =
    black --check --diff maas_cpu_analyzer/ tests/
    isort --check-only --diff maas_cpu_analyzer/ tests/

[testenv:security]
description = Run security checks
deps =
    bandit>=1.7.0
    safety>=2.3.0
    -r{toxinidir}/requirements-test.txt
commands =
    bandit -r maas_cpu_analyzer/ -ll
    safety check

[testenv:coverage]
description = Run tests with coverage
deps =
    pytest>=7.0.0
    pytest-cov>=4.0.0
    pytest-mock>=3.10.0
    -r{toxinidir}/requirements.txt
    -r{toxinidir}/requirements-test.txt
commands =
    pytest --cov=maas_cpu_analyzer --cov-report=html --cov-report=term-missing --cov-report=xml

[testenv:docs]
description = Build documentation
skip_install = True
deps =
    sphinx>=6.0.0
    sphinx-rtd-theme>=1.2.0
    myst-parser>=1.0.0
    -r{toxinidir}/requirements-test.txt
commands =
    sphinx-build -W -b html docs/ docs/_build/html

[flake8]
max-line-length = 88
extend-ignore =
    E203,
    W503,
    E501,
    D100,
    D101,
    D102,
    D103,
    D104,
    D105,
    D107,
    D400,
    D401,
    I100,
    I201
exclude =
    .git,
    __pycache__,
    .tox,
    .eggs,
    *.egg,
    build,
    dist,
    .venv,
    venv,
    .pytest_cache,
    .coverage,
    htmlcov

[mypy]
python_version = 3.9
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = False
ignore_missing_imports = True
exclude =
    tests/
    build/
    dist/
    .tox/
    .venv/
    venv/
